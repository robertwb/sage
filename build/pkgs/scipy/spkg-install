#!/usr/bin/env bash
# These flags confuse numpy's distutils.   In particular,
# if they are set empty bad things happen.

unset CFLAGS CXXFLAGS SHAREDFLAGS

if [ `uname` = "Darwin" ]; then
    unset ATLAS
    unset BLAS
    unset LAPACK
    export LDFLAGS="-bundle -undefined dynamic_lookup"
else
    ATLAS="$SAGE_LOCAL"
    export ATLAS
    BLAS="$SAGE_LOCAL"
    export BLAS
    LAPACK="$SAGE_LOCAL"
    export LAPACK
    export LDFLAGS="-shared"
fi
export FC="$SAGE_LOCAL/bin/sage_fortran"
export F77="$SAGE_LOCAL/bin/sage_fortran"
export F90="$SAGE_LOCAL/bin/sage_fortran"
export F95="$SAGE_LOCAL/bin/sage_fortran"


# This avoid problems on some systems -- until we officially
# support umfpack (which we will likely do, since cvxopt
# I think includes it).
#   http://projects.scipy.org/pipermail/scipy-user/2006-July/008661.html
# (Currently swig gets invoked by scipy when building the umfpack interace,
# which is bad.)

UMFPACK="None"; export UMFPACK
rm -rf "$SAGE_LOCAL"/lib/python/site-packages/scipy

cd src/

for patch in ../patches/*.patch; do
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done

if [ $? -ne 0 ]; then
    echo "Error patching setup.py"
    exit 1
fi

# Build
python setup.py build
if [ $? -ne 0 ]; then
    echo "Error building scipy."
    exit 1
fi

# Intall
python setup.py install
if [ $? -ne 0 ]; then
    echo "Error installing scipy."
    exit 1
fi
