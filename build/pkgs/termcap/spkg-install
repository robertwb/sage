#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

CFLAGS="-O2 -g -fPIC $CFLAGS"

if [ "x$SAGE64" = xyes ]; then
   CFLAGS="$CFLAGS -m64"
fi
export CFLAGS

cd src/

# Apply patches
for patch in ../patches/*.patch; do
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done


build()
{
    if [ ! -f Makefile ]; then
        ./configure --prefix="$SAGE_LOCAL"
        if [ $? -ne 0 ]; then
            echo "ERROR configuring termcap"
            exit 1
        fi
    fi
    $MAKE CFLAGS="$CFLAGS" install
    if [ $? -ne 0 ]; then
        echo "ERROR building termcap"
        exit 1
    fi
}

build

if [ $? -eq 0 -a $SAGE_LOCAL/lib/libtermcap.a ]; then
    echo "Success building termcap"
else
    echo "ERROR building termcap."
    exit 1
fi
