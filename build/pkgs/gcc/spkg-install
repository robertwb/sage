#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "SAGE_LOCAL undefined ... exiting"
    echo >&2 "Maybe run 'sage --sh'?"
    exit 1
fi


# Exit on error
set -e

# Build in a separate directory, not in src/ (a.k.a. a VPATH build).
# This is the recommended way to build GCC.
mkdir gcc-build
cd gcc-build


# The ld (linker) on old Darwin systems doesn't understand
# -compatibility_version, it needs -dylib_compatibility_version.
# Similarly for a few more options.  We create an ld wrapper to fix
# these command line options.
if { uname -sr | grep 'Darwin [0-9]\.' ;} &>/dev/null; then
    rm -f "$SAGE_LOCAL/bin/ld"
    LD=`which "${LD:-ld}"`

    echo '#!/bin/bash' >>"$SAGE_LOCAL/bin/ld"
    echo '# ld wrapper generated by the GCC spkg' >>"$SAGE_LOCAL/bin/ld"
    echo >>"$SAGE_LOCAL/bin/ld"
    # Hardcode the path to the "real" ld.
    echo "LD=$LD" >>"$SAGE_LOCAL/bin/ld"

cat >>"$SAGE_LOCAL/bin/ld" <<'EOF'

for arg in "$@"; do
    arg=`echo "$arg" | sed \
        -e 's/^-\(compatibility_version\)/-dylib_\1/' \
        -e 's/^-\(current_version\)/-dylib_\1/' \
        -e 's/^-\(install_name\)/-dylib_\1/' \
    `
    argv=("${argv[@]}" "$arg")
done

exec "$LD" "${argv[@]}"
EOF

    chmod +x "$SAGE_LOCAL/bin/ld"

    # Make GCC use this ld wrapper (found in the $PATH)
    export LD=ld
fi


if [ "$SAGE_CHECK" = yes ]; then
    # Enable internal checks in GCC.  These checks do not affect the
    # binaries produced by GCC, but they do increase the compile time
    # of everything compiled with GCC.
    CONFIGURE_FLAGS="$CONFIGURE_FLAGS --enable-checking=yes"
fi

# Use conservative CFLAGS for stage 1 and for the "build" executables
# (these are simple programs needed only internally for the build process).
MAKE="$MAKE CFLAGS_FOR_BUILD=-O0 STAGE1_CFLAGS=-O0"

# Disable bootstrap-debug on Darwin, since it doesn't work on an
# OS X 10.4 PPC machine.  bootstrap-debug only does additional checks,
# so it is safe not to use it.
if [ "$UNAME" = "Darwin" ]; then
    MAKE="$MAKE BUILD_CONFIG="
fi

# Use the assembler/linker specified by $AS/$LD if they differ from the
# default.
if [ -n "$AS" -a "$AS" != "as" ]; then
    CONFIGURE_AS="--with-as=$AS"
fi
if [ -n "$LD" -a "$LD" != "ld" ]; then
    CONFIGURE_LD="--with-ld=$LD"
fi


../src/configure \
    --prefix="$SAGE_LOCAL" \
    --with-local-prefix="$SAGE_LOCAL" \
    --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" --with-mpc="$SAGE_LOCAL" \
    --with-system-zlib \
    --disable-multilib \
    $CONFIGURE_FLAGS "$CONFIGURE_AS" "$CONFIGURE_LD"

$MAKE

$MAKE install


# Force re-installation of mpir, mpfr and mpc with the GCC we just built.
cd "$SAGE_ROOT/spkg/installed"
rm -f mpir-* mpfr-* mpc-*
