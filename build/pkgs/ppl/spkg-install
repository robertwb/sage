#!/usr/bin/env bash

if [ "x$SAGE_LOCAL" = x ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

if [ "x$CFLAG64" = x ]; then
    CFLAG64=-m64
fi

# If the environment variable SAGE64=yes, force building a 64-bit version:
if [ "x$SAGE64" = xyes ]; then
    echo "Building a 64-bit version of ppl"
    CC="$CC $CFLAG64"
    export CC
fi

# Dependencies check
MPIR_VERSION=`cd $SAGE_ROOT/spkg/; ./standard/newest_version mpir`
if [ $? -ne 0 ]; then
    echo "Failed to find mpir.  Please install the mpir spkg"
    exit 1
fi

# sage-env sets RM which will break libtool
# See http://trac.sagemath.org/sage_trac/ticket/7818#comment:28
unset RM

# Patch out tests that
# * fail to compile on Solaris gcc 4.5.1
# * break when setting MAKE="make -jN"
# They cover code that is not exposed by the Cython wrapper
cp -f patches/tests_Makefile.in src/tests/Makefile.in

# patch for SIGILL handler issue on i386
cp -f patches/fpu-ia32.cc src/src/fpu-ia32.cc

# Make sure that we prefer Sage's mpir library over system-wide gmp/mpir installs
LDFLAGS="$LDFLAGS -L$SAGE_LOCAL/lib"
export LDFLAGS
CXXFLAGS="$CXXFLAGS -I$SAGE_LOCAL/include"
export CXXFLAGS

cd src

./configure --prefix="$SAGE_LOCAL" --with-gmp-prefix="$SAGE_LOCAL" --enable-coefficients=mpz --enable-interfaces=c++
if [ $? -ne 0 ]; then
   echo "Error configuring the Parma Polyhedra Library."
   exit 1
fi

$MAKE
if [ $? -ne 0 ]; then
   echo "Error building the Parma Polyhedra Library."
   exit 1
fi

$MAKE install-strip
if [ $? -ne 0 ]; then
   echo "Error installing the Parma Polyhedra Library."
   exit 1
fi
