#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

cd src/

python setup.py install

if [ $? -ne 0 ]; then
   echo "Error installing SageTeX."
   exit 1
fi

docbuilderrmsg() {
    mkdir -p $SAGE_ROOT/local/share/doc/sagetex
    cat > $SAGE_ROOT/local/share/doc/sagetex/building_documentation_failed.txt <<EOF

If you're reading this, then someone tried to build the SageTeX
documentation by setting \$SAGE_SPKG_INSTALL_DOCS, but there was some
error.

If you just want the documentation, you can get \`example.pdf' and
\`sagetex.pdf' from http://bitbucket.org/ddrake/sagetex/downloads .

If you want to figure out what went wrong, try reinstalling the SageTeX
spkg and request that the documentation be built:

    env SAGE_SPKG_INSTALL_DOCS=yes sage -i sagetex

and see what goes wrong. Feel free to contact sage-support for further
help:

    http://groups.google.com/group/sage-support

EOF
}

if [ "x$SAGE_SPKG_INSTALL_DOCS" = xyes ] ; then
   if [ `command -v latex` ] ; then
      echo "Good, latex was found, so building the documentation"
   else
      echo "Sorry, can't build the documentation for SageTeX as latex is not installed."
      docbuilderrmsg
      exit 1
   fi

   make TEXOPTS=-interaction=nonstopmode sagetex.pdf &&\
   make TEXOPTS=-interaction=nonstopmode example.pdf

   if [ $? -ne 0 ]; then
      echo "Error building SageTeX docs."
      docbuilderrmsg
      exit 1
   fi
   mkdir -p $SAGE_ROOT/local/share/doc/sagetex
   cp -r example.pdf sagetex.pdf $SAGE_ROOT/local/share/doc/sagetex/
fi
