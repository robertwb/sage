#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

cd src

PRIME_SIZE=7

CCFLAGS_NO_SSE="-I$SAGE_LOCAL/include -Wall -O2 -fPIC -DRATPOINTS_MAX_BITS_IN_PRIME=$PRIME_SIZE"
CCFLAGS2="-L$SAGE_LOCAL/lib -lgmp -lm"
CCFLAGS3="-L. -lratpoints"

if [ `uname` = "Darwin" ]; then
    CCFLAGS1="$CCFLAGS_NO_SSE"
    CCFLAGS="-fnested-functions"
    echo "Building without SSE2 instructions (OS X)."
else
    CCFLAGS1="$CCFLAGS_NO_SSE -DUSE_SSE"
    CCFLAGS=""
fi

# When CFLAG64 is not set, set it to the default -m64
if [ -z $CFLAG64 ]; then
    CFLAG64=-m64
fi

if [ "x$SAGE64" = xyes ]; then
    echo "Building with extra 64-bit flags for OS X and Open Solaris"
    CCFLAGS="$CFLAG64 $CCFLAGS"
fi

export CCFLAGS1
export CCFLAGS2
export CCFLAGS3
export CCFLAGS


# PLEASE, don't break this again by deleting "libratpoints.a".  See trac 8267.
make libratpoints.a

if [ $? -ne 0 ]; then
    if [ "$UNAME" != "Darwin" ]; then
        echo "Build failed. Trying without SSE2 instructions."
        CCFLAGS1="$CCFLAGS_NO_SSE"; export CCFLAGS1
        make libratpoints.a
    else
        echo "Error building ratpoints"
        exit 1
    fi
    if [ $? -ne 0 ]; then
        echo "Error building ratpoints"
        exit 1
    fi
fi

cp libratpoints.a "$SAGE_LOCAL"/lib/
cp ratpoints.h "$SAGE_LOCAL"/include/
