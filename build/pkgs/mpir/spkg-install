#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo "Error: SAGE_LOCAL undefined - exiting..."
    echo "Maybe run 'sage -sh'?"
    exit 1
fi

CUR=`pwd`

# Add a patch which allow MPIR to build with Sun Studio:
if [ "x$UNAME" = "xSunOS" ]; then
    # XXX Independent of the actual compiler used?
    echo "Copying a version of gmp-h.in which is patched for Sun Studio..."
    cp patches/gmp-h.in src/
    if [ $? -ne 0 ]; then
        echo "Error: Failed to patch MPIR for Sun Studio."
        exit 1
    fi
fi

# The Yasm build uses PYTHON from the environment to find python,
# so unset it since the version from newest_version confuses it:
unset PYTHON

remove_pic_osx_32_bit()
{
    # Assumes we are in src/
    echo "Deleting assembly files which depend on PIC assembly" \
        "working or 32 bit OSX on Intel hardware..."
    rm mpn/x86/dive_1.asm
    rm mpn/x86/diveby3.asm
    rm mpn/x86/pentium4/sse2/dive_1.asm
    rm mpn/x86/pentium4/sse2/mode1o.asm
    rm mpn/x86/pentium4/sse2/diveby3.asm
    rm mpn/x86/pentium4/mmx/popham.asm
    rm mpn/x86/pentium4/mmx/rshift.asm
    rm mpn/x86/p6/mode1o.asm
    rm mpn/x86/p6/dive_1.asm
    rm mpn/x86/pentium/hamdist.asm
    rm mpn/x86/pentium/mod_1.asm
    rm mpn/x86/pentium/popcount.asm
    rm mpn/x86/pentium/mode1o.asm
    rm mpn/x86/pentium/dive_1.asm
}


if [ "$SAGE_DEBUG" = yes ]; then
    # Disable optimization, add debug symbols:
    CFLAGS="$CFLAGS -g -O0"
else
    # Add debug symbols by default, enable optimization:
    CFLAGS="-g -O3 $CFLAGS"
fi


build()
{
    # Also build the static library to be used by e.g. ECM:
    # SAGE_CONF_OPTS="--enable-shared --disable-static"
    SAGE_CONF_OPTS="--enable-shared --enable-static"
    # (Further options to 'configure' are added below.)

    case "$UNAME" in

    SunOS)
        if [ "$SAGE64" = "yes" ]; then
            echo "Building a 64-bit version of MPIR"
            ABI=64
        else
            ABI=32
        fi;;

    Darwin)
        if [ "$SAGE64" = "yes" ]; then
            # Note that we do not support 64-bit builds on PPC at all,
            # so we don't special-case on the architecture here.
            echo "Building a 64-bit version of MPIR"
            ABI=64
        else
            # Do not set ABI=32 on OS X 10.6, since there everything
            # defaults to 64-bit:
            if [ "`uname -r | sed 's/\..*//'`" != "10" ]; then
                # Assume MacOS X 10.4 or 10.5 (Darwin 8 or 9)
                ABI=32
                case "`uname -m`" in
                    i386)
                        # Remove x86 assembly code only:
                        remove_pic_osx_32_bit
                        ;;
                    ppc|ppc64)
                        # The Darwin assembler rejects code using an
                        # extended instruction set by default:
                        CFLAGS="$CFLAGS -Wa,-force_cpusubtype_ALL"
                        ;;
                esac
            fi
        fi;;

    Linux)
        # Work around (erroneously) set "executable stack" attributes,
        # causing runtime errors on Fedora 14 and other SELinux-
        # enabled systems:
        LDFLAGS="$LDFLAGS -Wl,-z,noexecstack"
        export LDFLAGS # perhaps redundant, but safe(r)

        if [ "$SAGE_FAT_BINARY" = "yes" ]; then
            # For now we do the same thing -- namely "--enable-fat" --
            # on both 64-bit and 32-bit, though this is likely to
            # change.
            case "`uname -m`" in
            i[3456]86)
                echo "** Building with FAT Binary Support (32-bit) **"
                SAGE_CONF_OPTS="$SAGE_CONF_OPTS --enable-fat"
                ;;
            x86_64|amd64)
                echo "** Building with FAT Binary Support (64-bit) **"
                SAGE_CONF_OPTS="$SAGE_CONF_OPTS --enable-fat"
                ;;
            *) # e.g. ia64 (Itanium) or PPC (ppc, ppc64)
                echo "Warning: Fat binary build currently not" \
                    "supported on this platform"
                # XXX or exit 1 ?
            esac
        fi

    esac

    export ABI CFLAGS CXXFLAGS

    echo "Using CC=$CC"
    echo "Using CFLAGS=$CFLAGS"
    echo "Using CPPFLAGS=$CPPFLAGS"
    echo "Using CXX=$CXX"
    echo "Using CXXFLAGS=$CXXFLAGS"
    echo "Using LDFLAGS=$LDFLAGS"
    echo "Using ABI=$ABI"
    echo "(These settings may get overridden by 'configure' or Makefiles.)"

    SAGE_CONF_OPTS="--enable-gmpcompat --enable-cxx=yes $SAGE_CONF_OPTS"

    if [ -z "$MPIR_EXTRA_OPTS" ]; then
        echo "Configuring MPIR with the following options:"
        echo "    --prefix=\"$SAGE_LOCAL\" $SAGE_CONF_OPTS"
        echo "You can set MPIR_EXTRA_OPTS to pass additional parameters."
    else
        echo "Using additional 'configure' options as specified with" \
            "MPIR_EXTRA_OPTS:"
        echo "    $MPIR_EXTRA_OPTS"
        echo "Configuring MPIR with the following options:"
        echo "    --prefix=\"$SAGE_LOCAL\" $SAGE_CONF_OPTS $MPIR_EXTRA_OPTS"
    fi

    ./configure --prefix="$SAGE_LOCAL" $SAGE_CONF_OPTS $MPIR_EXTRA_OPTS
    if [ $? -ne 0 ]; then
        echo "Error configuring MPIR. (See above for the options passed to it.)"
        exit 1
    fi

    $MAKE
    if [ $? -ne 0 ]; then
        echo "Error building MPIR."
        exit 1
    fi

    echo "Removing old headers and libraries..."
    rm -f "$SAGE_LOCAL"/include/mpir*.h "$SAGE_LOCAL"/include/gmp*.h
    rm -f "$SAGE_LOCAL"/lib/libmpir* "$SAGE_LOCAL"/lib/libgmp*

    $MAKE install
    if [ $? -ne 0 ]; then
        if [ "$UNAME" != "CYGWIN" ]; then  # On Cygwin an error is not fatal.
            echo "Error installing MPIR."
            # XXX This should be a temporary "solution":
            echo ""
            echo "If you see a message like:"
            cat <<EOF
    cp: cannot stat 'mpir.h': No such file or directory
    make[6]: *** [install-data-hook] Error 1
    make[6]: Leaving directory ...
    make[5]: *** [install-data-am] Error 2
    make[5]: *** Waiting for unfinished jobs....
EOF
            echo "above, this is just due to a rare race condition."
            echo "Please simply rerun 'make' (or 'sage -i ...')."
            echo ""
            exit 1
        fi
    fi
} # build()

cd src

build

# All errors catched in build(), on Cygwin we ignore the last:
exit 0
