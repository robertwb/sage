#!/usr/bin/env bash
###########################################
## GMP spkg-install
## AUTHOR:
##    -- Joe Weening (2006-02-19), jweening@ccrwest.org
##    -- William Stein (2006-11).
##    -- Jason Martin (2007-02): turn on support for some optimization patches.
##    -- David Harvey (2007-09): fast gcd patch
###########################################

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

remove_pic_osx_32_bit()
{
    echo "Deleting assembly files with depend on PIC working or 32 bit OSX on Intel hardware"
    rm mpn/x86/dive_1.asm
    rm mpn/x86/diveby3.asm
    rm mpn/x86/pentium4/sse2/dive_1.asm
    rm mpn/x86/pentium4/sse2/mode1o.asm
    rm mpn/x86/pentium4/sse2/diveby3.asm
    rm mpn/x86/pentium4/mmx/popham.asm
    rm mpn/x86/pentium4/mmx/rshift.asm
}


build()
{

    SAGE_CONF_OPTS="--enable-shared --disable-static"
    case $UNAME in

    SunOS)
        if [ "$SAGE64" = "yes" ]; then
            echo "Building 64 bit Solaris version"
            ABI=64
        else
            ABI=32
        fi;;

    Darwin)
        if [ "$SAGE64" = "yes" ]; then
            echo "Building 64 bit OSX version"
            ABI=64
        else
            ABI=32
            if [ `uname -m` = i386 ]; then
                remove_pic_osx_32_bit
            fi
        fi;;
    esac

    export ABI CFLAGS CXXFLAGS

    ./configure --prefix=$SAGE_LOCAL --enable-cxx=yes  $SAGE_CONF_OPTS
    if [ $? -ne 0 ]; then
        echo "Failed to configure."
	exit 1
    fi

    $MAKE
    if [ $? -ne 0 ]; then
        echo "Error building GMP."
        exit 1
    fi

    $MAKE install
    if [ $? -ne 0 ]; then
        if [ "$UNAME" != "CYGWIN" ]; then  # on cygwin error is not fatal.
            echo "Error installing GMP."
            exit 1
        fi
    fi

}

cd src

build

if [ $? -eq 0 ]; then
    exit 0
else
    echo "Failed to build shared GMP library."
    exit 1
fi
