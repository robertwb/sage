#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# Helper functions
success() {
    if [ $? -ne 0 ]; then
        echo "Error building Sphinx: '$1'"
        exit 1
    fi
}

echo "Removing old version..."
rm -rf "$SAGE_LOCAL"/lib/python/site-packages/Sphinx-*
success 'Error deleting previous version'

CUR=`pwd`

echo "Deleting old documentation output..."
cd "$SAGE_ROOT/devel"
for dir in `ls`; do
    if [ -d "$dir"/doc/output ]; then
        rm -rf "$dir"/doc/output
    fi
done
success 'Error deleting old documentation output'


# Apply patches
cd "$CUR/src"
echo "Patching Sphinx..."
for p in ../patches/*.patch; do
	patch -p1 <$p
	success "Error applying patch $p"
done


# Install new version
python setup.py install
success 'Error installing Sphinx'

cd ..
cp patches/sphinx-build "$SAGE_LOCAL/bin/"
success "Error copying sphinx-build to $SAGE_LOCAL/bin/"
