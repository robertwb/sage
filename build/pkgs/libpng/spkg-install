#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

unset RM

cd src

# Need to detect zlib
if [ "x$SAGE64" = xyes ]; then
    CFLAGS="-m64 $CFLAGS -fPIC -g"
    LDFLAGS="-m64"; export LDFLAGS
else
    CFLAGS="$CFLAGS -fPIC -g"
fi
export CFLAGS

CPPFLAGS="$CPPFLAGS -I$SAGE_LOCAL/include"
export CPPFLAGS


./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-shared=yes
if [ $? -ne 0 ]; then
    echo "Error configuring libpng"
    exit 1
fi

make

if [ $? -ne 0 ]; then
    echo "Error building libpng"
    exit 1
fi

make install

if [ $? -ne 0 ]; then
    echo "Error installing libpng"
    exit 1
fi

if [ $UNAME = "CYGWIN" ]; then
  rm -rf "$SAGE_LOCAL"/lib/libpng12.dll.a
  rm -rf "$SAGE_LOCAL"/lib/libpng12.la
  cp "$SAGE_LOCAL"/bin/cygpng12-0.dll "$SAGE_LOCAL"/lib/libpng12.dll

  if [ $? -ne 0 ]; then
      echo "Error installing libpng"
      exit 1
  fi
fi

echo "Deleting libpng.*"
rm -rf "$SAGE_LOCAL"/lib/libpng.*
