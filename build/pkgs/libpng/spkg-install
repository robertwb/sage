#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

unset RM

cd src

# Need to detect zlib
if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
    CFLAGS="-m64 $CFLAGS -fPIC -g -I$SAGE_LOCAL/include"
    LDFLAGS="-m64"; export LDFLAGS
else
    CFLAGS="$CFLAGS -fPIC -g -I$SAGE_LOCAL/include"
fi
export CFLAGS


./configure --prefix="$SAGE_LOCAL" --enable-shared=yes
if [ $? -ne 0 ]; then
    echo "Error configuring libpng"
    exit 1
fi

make

if [ $? -ne 0 ]; then
    echo "Error building libpng"
    exit 1
fi

make install

if [ $? -ne 0 ]; then
    echo "Error installing libpng"
    exit 1
fi

echo "Deleting libpng.*"
rm -rf "$SAGE_LOCAL"/lib/libpng.*
