#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ] ; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# Only build iconv on Solaris, HP-UX and Cygwin
# See
# http://trac.sagemath.org/sage_trac/ticket/8567
# and http://trac.sagemath.org/sage_trac/ticket/9603

if [ "x$UNAME" = xSunOS ] || [ "x$UNAME" = xHP-UX ] || [ "x$UNAME" = xCYGWIN ] ; then
   echo "iconv will be installed as the operating system is Cygwin, HP-UX or Solaris"
   echo "These system either lack iconv, or do not have a sufficiently capable"
   echo "iconv. See:"
   echo "http://trac.sagemath.org/sage_trac/ticket/8567"
   echo "http://trac.sagemath.org/sage_trac/ticket/9603"

   echo "First removing old iconv files if they exist"
   # If iconv is updated, please double-check these are still necessary
   # and that there are no extra files added.

   rm -f $SAGE_LOCAL/bin/iconv  $SAGE_LOCAL/lib/charset.alias
   rm -f $SAGE_LOCAL/lib/*libiconv*  $SAGE_LOCAL/lib/libcharset*
   rm -f $SAGE_LOCAL/include/iconv.h  $SAGE_LOCAL/include/libcharset.h
   rm -f $SAGE_LOCAL/include/localcharset.h
   rm -rf  $SAGE_LOCAL/share/doc/libiconv
   rm -f $SAGE_LOCAL/share/man/man1/iconv* $SAGE_LOCAL/share/man/man3/iconv*


   # Let an environment variable CFLAG64 specify the option to generate 64-bit
   # code. If this is not set, default to -m64.
   if [ -z "$CFLAG64" ] ; then
      CFLAG64=-m64
   fi

   # Add option for a 64-bit build if needed.
   if [ "x$SAGE64" = xyes ] ; then
      CFLAGS="$CFLAG64"
      export CFLAGS
   fi

   cd src
   ./configure --prefix=$SAGE_LOCAL
   if [ $? -ne 0 ]; then
      echo "Error configuring iconv"
      exit 1
   fi

   make
   if [ $? -ne 0 ]; then
      echo "Error building iconv"
      exit 1
   fi

   make install
   if [ $? -ne 0 ]; then
      echo "Error installing iconv"
      exit 1
   fi
   exit 0
else
   echo "iconv will not be installed, as we only need to build it on"
   echo "Solaris, HP-UX and Cygwin, as the system iconv will be"
   echo "used on other platforms, rather than the one shipped with Sage"
   echo "See:"
   echo "http://trac.sagemath.org/sage_trac/ticket/8567"
   echo "http://trac.sagemath.org/sage_trac/ticket/9603"
   exit 0
fi
