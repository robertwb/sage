#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
   echo "SAGE_LOCAL undefined ... exiting"
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# Only build iconv on Solaris, HP-UX and Cygwin
# See
# http://trac.sagemath.org/sage_trac/ticket/8567
# and http://trac.sagemath.org/sage_trac/ticket/9603

if [ "x$UNAME" = xSunOS ] || [ "x$UNAME" = xHP-UX ] || [ "x$UNAME" = xCYGWIN ]; then
   echo "iconv will be installed as the operating system is Cygwin, HP-UX or Solaris"
   echo "These system either lack iconv, or do not have a sufficiently capable"
   echo "iconv. See:"
   echo "http://trac.sagemath.org/sage_trac/ticket/8567"
   echo "http://trac.sagemath.org/sage_trac/ticket/9603"

   # Let an environment variable CFLAG64 specify the option to generate 64-bit
   # code. If this is not set, default to -m64.
   if [ -z "$CFLAG64" ]; then
      CFLAG64=-m64
   fi

   # If the environment variable SAGE64="yes", then build a 64-bit version.
   if [ "x$SAGE64" = xyes ]; then
      CFLAGS="$CFLAGS $CFLAG64"
      export CFLAGS
      echo "Building a 64-bit version of iconv"
   fi

   cd src
   ./configure --prefix="$SAGE_LOCAL"
   if [ $? -ne 0 ]; then
      echo "Error configuring iconv"
      exit 1
   fi

   $MAKE
   if [ $? -ne 0 ]; then
      echo "Error building iconv"
      exit 1
   fi

   $MAKE install
   if [ $? -ne 0 ]; then
      echo "Error installing iconv"
      exit 1
   fi
   exit 0
else
   echo "iconv will not be installed, as we only need to build it on"
   echo "Solaris, HP-UX and Cygwin, as the system iconv will be"
   echo "used on other platforms, rather than the one shipped with Sage"
   echo "See:"
   echo "http://trac.sagemath.org/sage_trac/ticket/8567"
   echo "http://trac.sagemath.org/sage_trac/ticket/9603"
   exit 0
fi
