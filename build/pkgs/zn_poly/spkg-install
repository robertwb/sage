#!/usr/bin/env bash

################################################################
#
#  zn_poly sage install script
#
################################################################

if [ -z "$SAGE_LOCAL" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# Let the user set an environment variable CFLAG64 to
# indicate the C compiler flag for 64-bit builds. By
# default this will be -m64. IBM's compiler on AIX
# and HP's on HP-UX do NOT use -m64.

if [ -z "$CFLAG64" ] ; then
   CFLAG64=-m64
fi

if [ "x$SAGE64" = xyes ]; then
   echo "Building a 64-bit version of zn_poly"
   CFLAGS="$CFLAGS $CFLAG64"
   CPPFLAGS="$CPPFLAGS $CFLAG64" ; export CPPFLAGS
   LDFLAGS="$LDFLAGS $CFLAG64" ; export LDFLAGS
   cp patches/makemakefile.py src/makemakefile.py
   CC="$CC $CFLAG64" ; export CC
fi

CFLAGS="$CFLAGS -g -fPIC -O3 -L."; export CFLAGS
LDFLAGS="$LDFLAGS"; export LDFLAGS

if [ "x$UNAME" = xSunOS ] && [  "`ld  --version  2>&1  | grep GNU`" = ""  ]; then
   # Change -soname to -h if the Sun linker is used.
   sed 's/-soname/-h/g' src/makemakefile.py > /tmp/makemakefile.py.$$
   mv /tmp/makemakefile.py.$$ src/makemakefile.py
fi

cp patches/mpn_mulmid-tune.c patches/mul-tune.c patches/mulmid-tune.c src/tune
if [ $? -ne 0 ]; then
	echo "Error patching."
	exit 1
fi

cd src

./configure --gmp-prefix="$SAGE_LOCAL" --ntl-prefix="$SAGE_LOCAL" \
            --prefix="$SAGE_LOCAL" --cflags="$CFLAGS" --ldflags="$LDFLAGS"

# optionally run tuning program, only takes 1 minute or so
$MAKE tune CC=$CC
if [ $? -ne 0 ]; then
	echo "Error building zn_poly tuning program."
	exit 1
fi
tune/tune > src/tuning.c

if [ $? -ne 0 ]; then
	echo "Error running tune program."
	exit 1
fi

$MAKE CC=$CC
if [ $? -ne 0 ]; then
	echo "Error building zn_poly."
	exit 1
fi

# run test suite (quick version)
$MAKE check CC=$CC

if [ $? -ne 0 ]; then
   echo "Error running zn_poly's quick test suite (make check)."
   exit 1
else
   echo ""
   echo "zn_poly's *quick* test suite passed. A more comprehensive"
   echo "test suite can be run if SAGE_CHECK is exported to \"yes\""
   echo "but it takes about 10x as long to run"
   echo ""
fi


# UNIX
if [ $UNAME != "Darwin" ]; then
    $MAKE libzn_poly.so CC=$CC
    if [ $? -ne 0 ]; then
        echo "Error building zn_poly shared library."
        exit 1
    fi
    $CP libzn_poly-0.9.so "$SAGE_LOCAL/lib/"
    (cd $SAGE_LOCAL/lib/ && ln -sf libzn_poly-0.9.so libzn_poly.so)
fi

# CYGWIN
if [ $UNAME = "CYGWIN" ]; then
    ln -s "$SAGE_LOCAL"/lib/libzn_poly.so "$SAGE_LOCAL"/lib/libzn_poly.dll
fi


# OS X
if [ $UNAME = "Darwin" ]; then
    if [ "$SAGE64" = "yes" ]; then
      $MAKE libzn_poly.dylib64 CC=$CC
    else
      $MAKE libzn_poly.dylib CC=$CC
    fi
    if [ ! -f libzn_poly.dylib ]; then
        echo "Failed to build zn_poly dylib."
        exit 1
    fi
    $CP libzn_poly.dylib "$SAGE_LOCAL/lib/"
fi

# copy header files

mkdir -p $SAGE_LOCAL/include/zn_poly
$CP include/zn_poly.h $SAGE_LOCAL/include/zn_poly
$CP include/wide_arith.h $SAGE_LOCAL/include/zn_poly


if [ $? -ne 0 ]; then
    echo "Error building zn_poly"
    exit 1
fi
