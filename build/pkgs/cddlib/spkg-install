#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# We depend on mpir, make sure it is installed (GMP fork)
MPIR_VERSION=`cd $SAGE_ROOT/spkg/standard/; ./newest_version mpir`
if [ $? -ne 0 ]; then
    echo "Failed to find mpir.  Please install the mpir spkg"
    exit 1
fi

if [ `uname` = "Darwin" ] && [ "$SAGE64" = "yes" ]; then
   echo "64 bit MacIntel"
   CFLAGS="$CFLAGS -m64 "; export CFLAGS
fi


# Patches to apply on top of the clean upstream source under src/.
patch() {

    # We currently do not use this. To be removed at a later date.
    cp patches/allfaces.c src/src/

    # Required by sage.geometry.polyhedra
    cp patches/cdd_both_reps.c src/src/
    cp patches/cdd_both_reps.c src/src-gmp/

    # Do not apply patches/automake.patch here!
    # The following is the result of applying automake.patch
    cp patches/src-gmp-Makefile.am src/src-gmp/Makefile.am
    cp patches/src-Makefile.am src/src/Makefile.am
    cp patches/lib-src-Makefile.am src/lib-src/
    cp patches/lib-src-gmp-Makefile.am src/lib-src-gmp/
    rm src/configure.in
    cp patches/configure.ac src/

    # remaining files are the result of running autoconf/automake
    cp -r patches/autogenerated/* src/
}


# sage-env sets RM which will break libtool
# See http://trac.sagemath.org/sage_trac/ticket/7818#comment:28
unset RM

# apply patches on top of pristine upstream release under src/
patch

cd src

./configure --prefix=$SAGE_LOCAL
if [ $? -ne 0 ]; then
   echo "Error configuring cddlib"
   exit 1
fi

$MAKE
if [ $? -ne 0 ]; then
   echo "Error building cddlib"
   exit 1
fi

$MAKE install
if [ $? -ne 0 ]; then
   echo "Error installing cddlib"
   exit 1
fi
