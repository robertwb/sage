#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
   echo "64 bit MacIntel"
   CFLAGS="$CFLAGS -m64 "; export CFLAGS
fi

cd src

CFLAGS="$CFLAGS -O2 -g -Wa,-W -fno-exceptions -Wno-deprecated -static-libgcc"

export CFLAGS
if [ "$UNAME" = "SunOS" ]; then
    LCALC_LIBS="-lpari -lmpfr -lgmpxx -lgmp -liberty"
else
    LCALC_LIBS="-lpari -lmpfr -lgmpxx -lgmp"
fi
export LCALC_LIBS

# disable Cygwin build for now
if [ "$UNAME" = "CYGWIN" ]; then
#    cp patches/Lcommandline_elliptic.cc src/src/
    echo "Sorry, the lcalc build is currently broken"
    echo 1
fi

cd src

echo "Building Rubinstein's lcalc program using $CXX..."

success() {
    if [ $? -ne 0 ]; then
        echo "Error building lcalc '$1'"
        exit 1
    fi
}

export DEFINES=""
cp ../../patches/Makefile.sage Makefile
make lcalc
success 'plain'

echo "Now copying over binary"
cp lcalc "$SAGE_LOCAL"/bin
success 'install'
