#!/usr/bin/env bash
#
# Script to prepare a PARI spkg for Sage.  This script is only for the
# package maintainer, not for building PARI during a Sage install.
# WARNING: This script will delete/overwrite files in this directory
# and its subdirectories!
#
# HOW TO MAKE THE SPKG:
# 1) ./spkg-make
# 2) rm -rf parisvn    (For final distribution, not necessary for testing)
# 3) cd ..; sage -pkg pari-2.4.3.whatever_the_name_of_the_package_is
#
# If something goes wrong, try rm -rf parisvn and try again.
#
# This script does the following:
# * If the directory ./parisvn/ exists, it is assumed to be a SVN
#   repository of the PARI sources.  If it does not exist, the SVN
#   sources are automatically downloaded.  In any case, the SVN sources
#   are updated to a specific version.
# * If the file parisvn/galdata.tgz does not exist, it is downloaded.
# * The same for the file parisvn/seadata-small.tgz
# * PARI is configured and built in the parisvn directory.  The built
#   executables are not needed, but some files generated in the
#   process (using bison for example) are needed.
# * The necessary files are copied from parisvn/ to src/ using a
#   mechanism very similar to "make svnsnapshot" from PARI.
# * The files parisvn/galdata.tgz and parisvn/seadata-small.tgz are
#   extracted.
#
# AUTHOR: Jeroen Demeyer (July 2010)


# Sanity check: must be run from current directory
if ! [ -f spkg-make ]; then
	echo >&2 "This script must be run from its own source directory!"
	exit 1
fi


# Clean an existing src/ directory
rm -rf src
mkdir src


# Download SVN sources to parisvn/
if ! [ -d parisvn ]; then
	svn checkout svn://pari.math.u-bordeaux.fr/pari/trunk parisvn
fi


# Download galdata.tgz and seadata-small.tgz
[ -f parisvn/galdata.tgz ] || wget -O parisvn/galdata.tgz \
	http://pari.math.u-bordeaux.fr/pub/pari/packages/galdata.tgz
[ -f parisvn/seadata-small.tgz ] || wget -O parisvn/seadata-small.tgz \
	http://pari.math.u-bordeaux.fr/pub/pari/packages/seadata-small.tgz


# Use the specified SVN version
cd parisvn
svn update -r 12623   # 12623 is PARI 2.4.3


# make pari (must run bison, etc...) but disable optimization to speed
# up compilation (the output of the compiling is not used anyway).
env CFLAGS="-O0" ./Configure || exit
make gp doc || exit


# Copy the needed files to src using a tar pipe.  This is based on code
# from config/settar.
#
# Added src/desc/pari.desc to remove build-time dependency on perl
# -- Jeroen Demeyer
tar c `config/get_MANIFEST && echo src/desc/pari.desc` | ( cd ../src && tar xv )

# Save svn version (see config/settar)
svnversion >../src/config/svnversion


# Extract the tgz files
for tgzfile in galdata.tgz seadata-small.tgz; do
	( cd ../src && tar xvz ) < "$tgzfile"
done


# We're done!
cd ..
echo "======================================================"
echo "Done downloading PARI and creating the src/ directory."
echo "If everything looks okay, proceed as follows:"
echo "  rm -rf parisvn"
echo "  cd .."
echo -n "  sage -pkg "; basename `pwd`
