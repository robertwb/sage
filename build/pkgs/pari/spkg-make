#!/bin/bash
#
# Script to prepare a PARI spkg for Sage.  This script is only for the
# package maintainer, not for building PARI during a Sage install.
# WARNING: This script will delete/overwrite files in this directory
# and its subdirectories!
#
# HOW TO MAKE THE SPKG:
# 1) ./spkg-make
# 2) rm -rf parisvn    (For final distribution, not necessary for testing)
# 3) cd ..; sage -pkg pari-2.4.3.whatever_the_name_of_the_package_is
#
# If something goes wrong, try rm -rf parisvn and try again.
#
# This script does the following:
# * If the directory ./parisvn/ exists, it is assumed to be a SVN
#   repository of the PARI sources.  If it does not exist, the SVN
#   sources are automatically downloaded.  You can update the SVN
#   repository by hand by doing cd parisvn; svn update
# * If the file parisvn/galdata.tgz does not exist, it is downloaded.
# * The same for the file parisvn/seadata-small.tgz
# * PARI is configured and built in the parisvn directory.  The built
#   executables are not needed, but some files generated in the
#   process (using bison for example) are needed.
# * The necessary files are copied from parisvn/ to src/ using a
#   mechanism very similar to "make release" from PARI.
# * The files parisvn/galdata.tgz and parisvn/seadata-small.tgz are
#   extracted to src/src.
# * The patches in patches/*.patch are applied and the complete patched
#   files are copied to patches/files
#
# AUTHOR: Jeroen Demeyer


# Sanity check: must be run from current directory
if ! [ -f spkg-make ]; then
	echo >&2 "This script must be run from its own source directory!"
	exit 1
fi


# Clean an existing src/ directory
rm -rf src
mkdir src


# Download SVN sources to parisvn/
if ! [ -d parisvn ]; then
	svn checkout svn://pari.math.u-bordeaux.fr/pari/trunk parisvn
fi


# Download galdata.tgz and seadata-small.tgz
[ -f parisvn/galdata.tgz ] || wget -O parisvn/galdata.tgz \
	http://pari.math.u-bordeaux.fr/pub/pari/packages/galdata.tgz
[ -f parisvn/seadata-small.tgz ] || wget -O parisvn/seadata-small.tgz \
	http://pari.math.u-bordeaux.fr/pub/pari/packages/seadata-small.tgz


	# make pari (must run bison, etc...)
cd parisvn
./Configure || exit
make gp doc || exit


# Copy the needed files to src using a tar pipe.  This is based on code
# from config/settar.
tar c `config/get_MANIFEST` | ( cd ../src && tar xv )


# Extract the tgz files
for tgzfile in galdata.tgz seadata-small.tgz; do
	( cd ../src && tar xvz ) < "$tgzfile"
done


# Run through the patches in patches/*.patch and prepare the patched
# files in patches/files
rm -rf ../patches/files
mkdir ../patches/files
for patch in ../patches/*.patch; do
	# Check that every patch file changes only one file
	numfilesinpatch=`grep -c -e '^+++ ' "$patch"`
	if [ "$numfilesinpatch" != "1" ]; then
		echo "Bad patch file $patch.  It must patch exactly one file."
	fi

	srcfile=`sed -n 's|^+++ \([^\t]*\)\(\t.*\)\?|\1|p' "$patch"`
	outfile="../patches/files/`basename $srcfile`"
	patch -o "$outfile" -p0 <"$patch" || exit
	chmod "--reference=$srcfile" "$outfile"
done

cd ..

# Get status from svn and store in patches/status (for lack of a better place)
( cd parisvn; TOP=.; . config/version; echo "$status" ) >patches/status


# We're done!
echo "======================================================"
echo "Done downloading PARI and creating the src/ directory."
echo "If everything looks okay, proceed as follows:"
echo "  rm -rf parisvn"
echo "  cd .."
echo -n "  sage -pkg "; basename `pwd`
