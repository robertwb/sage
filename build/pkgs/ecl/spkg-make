#!/usr/bin/env bash
#
# Script to prepare a ECL spkg for Sage.  This script is only for the
# package maintainer, not for building ECL during a Sage install.
# WARNING: This script will delete/overwrite files in this directory
# and its subdirectories!
#
# HOW TO MAKE THE SPKG:
# 1) ./spkg-make
# 3) cd ..; sage -pkg ecl-[version]
#
# AUTHOR: Jeroen Demeyer (November 2011)

# Sanity check: must be run from current directory
if ! [ -f spkg-make ]; then
        echo >&2 "This script must be run from its own source directory!"
        exit 1
fi

# Exit on failure
set -e

# Clean an existing src/ and ecl/ directory
rm -rf src ecl

# Download CVS sources
ECLVERSION=-D20111115
cvs -z3 -d:pserver:anonymous@ecls.cvs.sourceforge.net:/cvsroot/ecls checkout $ECLVERSION ecl
mv ecl src

# Remove unneeded files to save space
cd src
find . \( -name CVS -o -name '.cvs*' -o -name '.git*' \) -exec rm -r {} \; -prune
rm -r msvc contrib/encodings contrib/unicode
cd src
rm -rf gc-unstable libffi

# Remove almost everything from gmp directory
mv gmp gmp-remove
# Save a few files
mkdir gmp
cp -p gmp-remove/config.* gmp-remove/configfsf.* gmp-remove/install*sh gmp
rm -r gmp-remove
