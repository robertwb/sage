#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

PBDIR=polybori-0.6.4
WORKDIR=${PWD}/src
SCONS=scons

# For some strange reason the installed boost in $SAGE_LOCAL causes
# make install failures, so copy it over.
#mkdir src/boost_1_34_1.cropped
#cp -r $SAGE_LOCAL/include/boost src/boost_1_34_1.cropped

#BOOSTDIR=boost_1_34_1.cropped	# obsolete, only used by spkg-install
#BOOSTINCDIR=${WORKDIR}/${BOOSTDIR}
#BOOSTINCDIR=${SAGE_LOCAL}/include/boost # we now only use that; Boost is a standard spkg
#export BOOSTINCDIR # used by scons - that's also obsolete

patch()
{
    cp patches/custom.py src/${PBDIR}

    if [ $UNAME = "CYGWIN" ]; then
        export PROGSUFFIX=.exe
    fi

    cp patches/SConstruct            src/${PBDIR}/SConstruct
    cp patches/PyPolyBoRi.py         src/${PBDIR}/pyroot/polybori
    cp patches/pbori_routines_misc.h src/${PBDIR}/polybori/include/
    cp patches/ll.py                 src/${PBDIR}/pyroot/polybori
    cp patches/nf.cc                 src/${PBDIR}/groebner/src/
    cp patches/BooleEnv.h            src/${PBDIR}/polybori/include/
    cp patches/BooleEnv.cc           src/${PBDIR}/polybori/src/
}


build_polybori()
{
    cd ${PBDIR}
    ${SCONS} prepare-devel ${MAKEOPTS}
    if [ $? -ne 0 ]; then
        echo "Error building PolyBoRi."
        exit 1
    fi
    cd ${WORKDIR}
}

install_polybori()
{
    cd ${PBDIR}
    ${SCONS} devel-install install PREFIX=${SAGE_LOCAL} INSTALLDIR=${SAGE_LOCAL}/share/polybori
    if [ $? -ne 0 ]; then
        echo "Error installing PolyBoRi."
        exit 1
    fi
    #if [ -e ${SAGE_LOCAL}/lib/python/site-packages/polybori ] ; then
    #    rm  -rf ${SAGE_LOCAL}/lib/python/site-packages/polybori
    #fi
    cd ${WORKDIR}
}

clean_polybori()
{
    rm -f ${SAGE_LOCAL}/lib/libpolybori*
    rm -f ${SAGE_LOCAL}/lib/libpboriCudd*
    rm -f ${SAGE_LOCAL}/lib/libgroebner*
    rm -rf ${SAGE_LOCAL}/include/polybori
    rm -rf ${SAGE_LOCAL}/include/cudd
}

patch

cd src

echo "Starting build..."

echo "Removing old PolyBoRi install..."
clean_polybori
echo "Done removing old PolyBoRi install."

echo "Running build_polybori..."
build_polybori
echo "Done build_polybori."

echo "Installing PolyBoRi..."
install_polybori
echo "Done installing PolyBoRi."
