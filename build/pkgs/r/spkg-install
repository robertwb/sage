#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

if [ "x$SAGE64" = xyes  ]; then
   echo "Building R 64 bit."
   CFLAGS="-O2 -g -m64 "; export CFLAGS
   LDFLAGS="-m64 "; export LDFLAGS
fi

if [ "$UNAME" = "Darwin" ]; then
   echo "Copying fake java and javac compiler on OSX"
   cp patches/java "$SAGE_LOCAL"/bin
   cp patches/javac "$SAGE_LOCAL"/bin
fi


# set CPPFLAGS so that Sage's readline & iconv are picked up
CPPFLAGS="-I$SAGE_LOCAL/include $CPPFLAGS"; export CPPFLAGS

# Note by Karl-Dieter Crisman, April 12th 2010. X support would be nice
# to have in OSX, but see
# http://CRAN.R-project.org/bin/macosx/RMacOSX-FAQ.html#X11-window-server-_0028optional_0029
# for how differently this would have to be handled on different OSX
# versions, none trivially.  In any case, aqua, which we enable,
# performs the same function on OSX.
#
# Also, see #12172: for now, anyway, we disable X support on OS X.
#
# Note by David Kirkby, Feb 16th 2010. /usr/include/X11/Xwindows.h does
# not exist on Solaris, but R configures OK with X support. Hence I've added
# a more specific test on Solaris, by testing for a library. That library
# exists both on Solaris 10 03/2005 (SPARC) and on OpenSolaris.
if [ "$UNAME" = "Darwin" ]; then
    XSUPPORT=no
elif [ -f /usr/include/X11/Xwindows.h ]; then
    XSUPPORT=yes
else
   if [ "$UNAME" = "SunOS" ] && [ -f /usr/X11/lib/libXv.so ] ; then
       XSUPPORT=yes
   else
       XSUPPORT=no
   fi
fi

OSXFW=
if [ "$UNAME" = "Darwin" ]; then
    # We don't want to install R as a library framework on OSX
    OSXFW="--enable-R-framework=no"
fi

if [ "$UNAME" = "SunOS" ]; then
    # Note by David Kirkby, 16th Feb 2010. Even after adding the iconv library
    # R would not build properly on Solaris 10, complaining of undefined symbols
    # uiter_setUTF8 and  ucol_strcollIter
    # After an email to r-help@r-project.org, Ei-ji Nakama (rim.nakama@gmail.com)
    # emailed me and said the option --without-ICU might help, which it did. I don't see
    # this option documented, but for now at least, it does allow R to build.

    echo "Disabling ICU on Solaris, using an undocumented option --without-ICU"
    echo "since the ICU library is not included on Solaris."
    SUN_FLAGS="--without-ICU"; export SUN_FLAGS
fi

# let's remove old install, even the wrongly installed ones
rm -rf "$SAGE_LOCAL"/lib/r
rm -rf "$SAGE_LOCAL"/lib/R
rm -rf "$SAGE_LOCAL"/lib64/R
rm -rf "$SAGE_LOCAL"/lib64/r
# and let's also nuke some leftovers on SAGE_LOCAL/lib
rm -rf "$SAGE_LOCAL"/lib/libRblas.so "$SAGE_LOCAL"/lib/libRlapack.so "$SAGE_LOCAL"/lib/libR.so
rm -rf "$SAGE_LOCAL"/lib/libRblas.dylib "$SAGE_LOCAL"/lib/libRlapack.dylib "$SAGE_LOCAL"/lib/libR.dylib

cd src

# Apply patches.  See SPKG.txt for information about what each patch
# does.
for patch in ../patches/*.patch; do
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done

# Don't override R_HOME_DIR in local/bin/R while building R.
# See patches/R.sh.patch
export SAGE_BUILDING_R=yes

# make sure the prefix is always lib, not lib64 on 64 bit linux
LIBnn="lib"; export LIBnn

FC=sage_fortran; export FC
F77=sage_fortran; export F77

# These flags are *critical* so that R will be built against Sage's
# copy of readline and ATLAS.
CFLAGS="-I$SAGE_LOCAL/include -L$SAGE_LOCAL/lib/ $CFLAGS"; export CFLAGS
LDFLAGS="-L$SAGE_LOCAL/lib/ $LDFLAGS"; export LDFLAGS

if [ "$UNAME" = "Darwin" ]; then
     echo "Configuring R for OSX"
    ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-R-shlib --with-x=$XSUPPORT --with-readline="$SAGE_LOCAL" $OSXFW
else
     echo "Configuring R with ATLAS"
     if [ "x$SAGE_FAT_BINARY" = xyes ] ; then
      ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-R-shlib --with-x=$XSUPPORT --with-readline="$SAGE_LOCAL" --with-blas="-L$SAGE_LOCAL/lib -lf77blas -latlas" --with-lapack="-L$SAGE_LOCAL/lib -llapack -lcblas" --with-ICU=no
     else
      ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-R-shlib --with-x=$XSUPPORT --with-readline="$SAGE_LOCAL" --with-blas="-L$SAGE_LOCAL/lib -lf77blas -latlas" --with-lapack="-L$SAGE_LOCAL/lib -llapack -lcblas" $SUN_FLAGS
     fi
fi

if [ $? -ne 0 ]; then
     echo "Configuring R with fallback options"
    ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-R-shlib --with-x=no --with-readline="$SAGE_LOCAL" $OSXFW $SUN_FLAGS
fi

if [ $? -ne 0 ]; then
    echo "Error configuring R."
    exit 1
fi

$MAKE R
if [ $? -ne 0 ]; then
    echo "Error building R."
    exit 1
fi

# Disable parallel make install, which is supposedly broken
$MAKE -j1 vignettes  # Needed for help system
$MAKE -j1 install
if [ $? -ne 0 ]; then
    echo "Error installing R."
    exit 1
fi

#$MAKE install-libR
#if [ $? -ne 0 ]; then
#    echo "Error installing libR."
#    exit 1
#fi

if [ "$UNAME" = "Darwin" ]; then
    echo "Removing fake java and javac compiler"
    rm -f "$SAGE_LOCAL"/bin/java
    rm -f "$SAGE_LOCAL"/bin/javac
fi
