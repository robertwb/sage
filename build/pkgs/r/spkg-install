#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

if [ "x$SAGE64" = xyes  ]; then
   echo "Building R 64 bit."
   CFLAGS="-O2 -g -m64 "; export CFLAGS
   LDFLAGS="-m64 "; export LDFLAGS
fi

if [ "$UNAME" = "Darwin" ]; then
   echo "Copying fake java and javac compiler on OSX"
   cp patches/java "$SAGE_LOCAL"/bin
   cp patches/javac "$SAGE_LOCAL"/bin
fi

CUR=`pwd`

# set CPPFLAGS so that Sage's readline & iconv are picked up
CPPFLAGS="-I$SAGE_LOCAL/include $CPPFLAGS"; export CPPFLAGS

# Hack to get around dumb hardcoding.
cp patches/R.sh.in src/src/scripts/

# Note by Karl-Dieter Crisman, April 12th 2010. X support would be nice
# to have in OSX, but see
# http://CRAN.R-project.org/bin/macosx/RMacOSX-FAQ.html#X11-window-server-_0028optional_0029
# for how differently this would have to be handled on different OSX
# versions, none trivially.  In any case, aqua, which we enable,
# performs the same function on OSX.
#
# Also, see #12172: for now, anyway, we disable X support on OS X.
#
# Note by David Kirkby, Feb 16th 2010. /usr/include/X11/Xwindows.h does
# not exist on Solaris, but R configures OK with X support. Hence I've added
# a more specific test on Solaris, by testing for a library. That library
# exists both on Solaris 10 03/2005 (SPARC) and on OpenSolaris.
if [ "$UNAME" = "Darwin" ]; then
    XSUPPORT=no
elif [ -f /usr/include/X11/Xwindows.h ]; then
    XSUPPORT=yes
else
   if [ "$UNAME" = "SunOS" ] && [ -f /usr/X11/lib/libXv.so ] ; then
       XSUPPORT=yes
   else
       XSUPPORT=no
   fi
fi

# we don't want to install R as a library framework on OSX
if [ "$UNAME" = "Darwin" ]; then
    OSXFW="--enable-R-framework=no"; export OSXFW
else
    OSXFW=""; export OSXFW
fi

if [ "$UNAME" = "SunOS" ]; then
    # Note by David Kirkby, 16th Feb 2010. Even after adding the iconv library
    # R would not build properly on Solaris 10, complaining of undefined symbols
    # uiter_setUTF8 and  ucol_strcollIter
    # After an email to r-help@r-project.org, Ei-ji Nakama (rim.nakama@gmail.com)
    # emailed me and said the option --without-ICU might help, which it did. I don't see
    # this option documented, but for now at least, it does allow R to build.

    echo "Disabling ICU on Solaris, using an undocumented option --without-ICU"
    echo "since the ICU library is not included on Solaris."
    SUN_FLAGS="--without-ICU"; export SUN_FLAGS
fi

# let's remove old install, even the wrongly installed ones
rm -rf "$SAGE_LOCAL"/lib/r
rm -rf "$SAGE_LOCAL"/lib/R
rm -rf "$SAGE_LOCAL"/lib64/R
rm -rf "$SAGE_LOCAL"/lib64/r
# and let's also nuke some leftovers on SAGE_LOCAL/lib
rm -rf "$SAGE_LOCAL"/lib/libRblas.so "$SAGE_LOCAL"/lib/libRlapack.so "$SAGE_LOCAL"/lib/libR.so
rm -rf "$SAGE_LOCAL"/lib/libRblas.dylib "$SAGE_LOCAL"/lib/libRlapack.dylib "$SAGE_LOCAL"/lib/libR.dylib

cd src

# make sure the prefix is always lib, not lib64 on 64 bit linux
LIBnn="lib"; export LIBnn

FC=sage_fortran; export FC
F77=sage_fortran; export F77

# These flags are *critical* so that R will be built against Sage's
# copy of readline and ATLAS.
CFLAGS="-I$SAGE_LOCAL/include -L$SAGE_LOCAL/lib/ $CFLAGS"; export CFLAGS
LDFLAGS="-L$SAGE_LOCAL/lib/ $LDFLAGS"; export LDFLAGS

# FreeBSD needs the path to libiconv to be explicitly specified.  In theory,
# --with-libiconv-prefix should work but configure script is broken and
# ignores that path when looking for libiconv.  Hard-wire via xxFLAGS.
# Note by David Kirkby, 16th Feb 2010. The option --with-libiconv-prefix
# is not documented in the latest R manual, neither is it an option if you
# type 'configure --help'.  Since there is an iconv library going to be
# integrated into Sage - see http://trac.sagemath.org/sage_trac/ticket/8191
# it is likely these FreeBSD specific lines can be removed, but I'll leave
# them here for a FreeBSD developer to address.
if [ "$UNAME" = "FreeBSD" ]; then
    CPPFLAGS="$CPPFLAGS -I/usr/local/include"
    CFLAGS="$CFLAGS -I/usr/local/include"
    LDFLAGS="$LDFLAGS -L/usr/local/lib"
fi

if [ "$UNAME" = "Darwin" ]; then
     echo "Configuring R for OSX"
    ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-R-shlib --with-x=$XSUPPORT --with-readline="$SAGE_LOCAL" $OSXFW
else
     echo "Configuring R with ATLAS"
     if [ "x$SAGE_FAT_BINARY" = xyes ] ; then
      ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-R-shlib --with-x=$XSUPPORT --with-readline="$SAGE_LOCAL" --with-blas="-L$SAGE_LOCAL/lib -lf77blas -latlas" --with-lapack="-L$SAGE_LOCAL/lib -llapack -lcblas" --with-ICU=no
     else
      ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-R-shlib --with-x=$XSUPPORT --with-readline="$SAGE_LOCAL" --with-blas="-L$SAGE_LOCAL/lib -lf77blas -latlas" --with-lapack="-L$SAGE_LOCAL/lib -llapack -lcblas" $SUN_FLAGS
     fi
fi

if [ $? -ne 0 ]; then
     echo "Configuring R with fallback options"
    ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" --enable-R-shlib --with-x=no --with-readline="$SAGE_LOCAL" $OSXFW $SUN_FLAGS
fi

if [ $? -ne 0 ]; then
    echo "Error configuring R."
    exit 1
fi

$MAKE R
if [ $? -ne 0 ]; then
    echo "Error building R."
    exit 1
fi

#parallel make install is broken
export MAKE=make
# We clear MAKEFLAGS to fix building multiple spkgs in parallel on OS X.
export MAKEFLAGS=

$MAKE vignettes #needed for help system
$MAKE install
if [ $? -ne 0 ]; then
    echo "Error installing R."
    exit 1
fi

#$MAKE install-libR
#if [ $? -ne 0 ]; then
#    echo "Error installing libR."
#    exit 1
#fi

# Fix hardcoding problems.
cd "$CUR"/patches
python fix_hardcode

cd "$CUR"


RPY_VER=rpy2-2.0.8

echo "Now installing the contained Rpy ($RPY_VER) spkg..."

# Do NOT call $SAGE_ROOT/sage here, since $SAGE_LOCAL/bin/sage-sage
# might not yet exist.
# See http://trac.sagemath.org/sage_trac/ticket/8306#comment:29
# and http://trac.sagemath.org/sage_trac/ticket/9896#comment:95
# Instead, as a temporary solution before Rpy gets removed from
# R's spkg (#9906), call $SAGE_LOCAL/bin/sage-spkg directly since
# it is present in any case (installed by spkg/base/dir-0.1-install)
# and the environment is already set up:

# Avoid trouble with pipestatus and spaces in the spkg's pathname:
export RPY_PKG=$CUR/$RPY_VER.spkg

# sage-spkg is in the PATH (but not pipestatus):
"$SAGE_ROOT/spkg/pipestatus" \
    "sage-spkg -f '$RPY_PKG' 2>&1" \
    "tee -a '$SAGE_ROOT/spkg/logs/'$RPY_VER.log"

if [ $? -ne 0 ] || [ ! -f "$SAGE_ROOT"/spkg/installed/"$RPY_VER" ]; then
    echo "Error installing Rpy, which is part of the R spkg."
    exit 1
fi

if [ "$UNAME" = "Darwin" ]; then
    echo "Copying fake java and javac compiler on OSX"
    rm -f "$SAGE_LOCAL"/bin/java
    rm -f "$SAGE_LOCAL"/bin/javac
fi
