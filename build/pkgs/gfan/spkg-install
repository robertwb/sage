#!/usr/bin/env bash
#xxxxxxxxxxxxxxxxx

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

if [ "x$SAGE64" = "xyes" ] ; then
   CFLAGS="$CFLAGS -m64"
   CXXFLAGS="$CXXFLAGS -m64"
   CFLAG64=-m64
   CXXFLAG64=-m64
fi

# patch the Makefile so it can build in Sage
echo "Copying a revised Makefile, to improve portability"
cp patches/Makefile src/
if [ $? -ne 0 ]; then
   echo "Patch to improve portability did not copy correctly"
   exit 1
fi

# patch polynomial.cpp to fix a bug, as suggested by Anders Jensen
# this should not be necessary any more (and can be removed) in
# the next release of gfan (following 0.4plus).
echo "Copying a patched polynomial.cpp"
cp patches/polynomial.cpp src/
if [ $? -ne 0 ]; then
   echo "Patch to fix polynomial.cpp did not copy correctly"
   exit 1
fi


cd src/

rm -f "$SAGE_LOCAL/bin/gfan*"

export CC
export CXX
export CFLAGS
export CFLAG64
export CXXFLAGS
export CXXFLAG64

$MAKE  cddpath=$SAGE_LOCAL


if [ $? -ne 0 ]; then
   echo "Error building gfan"
   exit 1
fi

if [ ! -f gfan ]; then
   echo "gfan executable not found."
   exit 1
fi

$CP gfan "$SAGE_LOCAL/bin/"

if [ ! -f "$SAGE_LOCAL/bin/gfan" ]; then
   echo "gfan executable not copied"
   exit 1
fi

cd "$SAGE_LOCAL/bin/"
rm gfan_*
./gfan installlinks

if [ ! -f "$SAGE_LOCAL/bin/gfan_buchberger" ]; then
   echo "gfan links not created correctly"
   exit 1
fi
