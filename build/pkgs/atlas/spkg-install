#!/bin/sh

###########################################
## ATLAS
###########################################

# we need to disable parallel builds
MAKE=make
FCOMPILER="$SAGE_LOCAL"/bin/sage_fortran
bitwidth=`python ./bitwidth.py`
echo "Platform detected to be $bitwidth bits"

config()
{
        mkdir ATLAS-build
	cd ATLAS-build
	# -Si cputhrchk 0: Ignore/heed CPU throttle probe
	# -Fa alg -fPIC: set flags so we can build dynamic libraries
	# -t 0: disable threading for now.
	../src/ATLAS/configure --prefix="$SAGE_LOCAL" --with-netlib-lapack="$SAGE_LOCAL"/lib/liblapack.a  \
	-Si cputhrchk 0 -Fa alg -fPIC -t 0 -C if $FCOMPILER -b $bitwidth
}


build()
{
	# build library
	cd $CUR/ATLAS-build
	make

	# now build the shared libraries
	cd lib
	make shared cshared

	# and now install
	cd ..
	make install
}

if [ `uname` = "Darwin" ]; then
    exit 0
fi


CUR=`pwd`

config

build

cd $CUR/ATLAS-build
if [ -f error* ]; then
    echo "ATLAS failed to build because your system is too heavily loaded to obtain accurate timing."
    echo "Please restart the build by typing make, when the load on your system has decreased."
    exit 1
fi

cd $CUR
sh ./make_correct_shared.sh
