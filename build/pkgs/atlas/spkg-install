#!/usr/bin/env python

import os, random, sys, time

##############################################
# Apply a TEMPORARY fix to allow ATLAS to build with
# gcc 4.4.0 on Solaris. Implemented 16th June 2009, by David Kirkby.
# One would expect to remove this within a couple of months,
# once the underlying issue in ATLAS is resolved. The patch
# forces

import shutil
if os.uname()[0] == 'SunOS':
   shutil.copy2('patches/mmsearch-with-temp-Solaris-fix.c','src/tune/blas/gemm/mmsearch.c')
##############################################

##############################################
## Build ATLAS repeatedly up to 5 times until
## it works. Pause a random amount of time
## between each build attempt.
##
## AUTHOR: William Stein, 2009-02-20
##############################################

max_tries = 5

for i in range(max_tries):
    # e = shift by 8 to get correct exit code, which could be needed
    # for better error handling later.
    e = os.system('./spkg-install-script') >> 8
    if e == 0:
        # build success
        sys.exit(0)
    if os.path.exists('ATLAS-build') and \
           len([x for x in os.listdir('ATLAS-build') if x.startswith('error')]) > 0:
        if i == max_tries - 1:
            print "Too many failures to build atlas.  Giving up!"
            sys.exit(1)
        print "ATLAS failed to build for the %s-th time, possibly because of a"%(i+1)
        print "loaded system, so we will automatically try again up to %s more times."%(max_tries-i-1)
        s = random.randint(300,900)
        print "Waiting %s minutes..."%(s//60)
        time.sleep(s)
    else:
        print "Failed to build ATLAS."
        sys.exit(1)
