#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo "SAGE_LOCAL undefined ... exiting"
    echo "Maybe run 'sage -sh'?"
    exit 1
fi

if [ "x$SAGE64" = xyes ]; then
    echo "Compiling Mercurial as 64-bit"
    if [ -z "$CFLAG64" ]; then
        CFLAG64="-m64"
    fi
    # Note that while exporting CFLAGS is redundant here,
    # exporting CXXFLAGS currently is NOT (bug in sage-env):
    CFLAGS="-O2 -g $CFLAGS $CFLAG64"; export CFLAGS
    CXXFLAGS="-O2 -g $CXXFLAGS $CFLAG64"; export CXXFLAGS
fi

CUR=`pwd`

cp patches/posix.py src/mercurial/posix.py
if [ $? -ne 0 ]; then
    echo "Error copying patch"
    exit 1
fi

# Remove existing copies of Mercurial:
rm -rf "$SAGE_LOCAL/lib/python/mercurial"

cd src

python setup.py install --home="$SAGE_LOCAL" --force
if [ $? -ne 0 ]; then
    echo "Error building and installing Mercurial"
    exit 1
fi

mkdir -p "$SAGE_LOCAL/etc/mercurial"
cat > "$SAGE_LOCAL/etc/mercurial/hgrc" <<HEREDOC
[trusted]
users = $USER

[diff]
git = true

[extensions]
color =
mq =
pager =
rebase =
relink =

[pager]
attend = annotate, cat, diff, log, glog, qdiff
HEREDOC
if [ $? -ne 0 ]; then
    echo "Error installing custom hgrc"
fi

if [ "$UNAME" = "Darwin" ]; then
    echo 'Copying custom hgmerge script over to $SAGE_LOCAL/bin/'
    cd "$CUR"
    cp patches/hgmerge-osx "$SAGE_LOCAL/bin/hgmerge"
    if [ $? -ne 0 ]; then
        echo "Error copying custom hgmerge script"
        exit 1 # Really exit?
    fi
fi

echo "Deleting dead links"
cd "$SAGE_LOCAL/lib"
rm -rf python/python2.6 python/python

exit 0
