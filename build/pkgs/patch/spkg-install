#!/usr/bin/env bash

if [ -z $SAGE_LOCAL ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# Let the user define the environment variable CFLAG64 to
# something if their C compiler needs a compiler flag other than
# -m64 to build 64-bit objects. This would be the case with IBM's
# compiler on AIX and HP's compiler on HP-UX. But -m64 works
# with both GCC and SunStudio.

if [ -z $CFLAG64 ] ; then
   CFLAG64="-m64"
fi

# Create a 64-bit build if the environment variable SAGE64 is set to
# "yes".

if [ "x$SAGE64" = xyes ] ; then
   echo "Creating a 64-bit version of GNU patch"
   CFLAGS="$CFLAGS $CFLAG64"
   export CFLAGS
   LDFLAGS="$LDFLAGS $CFLAG64"
   export LDFLAGS
fi

cd src

./configure --prefix="$SAGE_LOCAL"

if [ $? -ne 0 ]; then
    echo "Error configuring GNU patch"
    exit 1
fi

$MAKE

if [ $? -ne 0 ]; then
    echo "Error building GNU patch"
    exit 1
fi

$MAKE install

if [ $? -ne 0 ]; then
    echo "Error installing GNU patch"
    exit 1
fi

# Sanity check that we have the correct version of patch
# in our PATH.
if ! patch --version | grep >/dev/null 'patch 2\.5\.9'; then
    echo "Cannot find the patch program we just installed"
    exit 1
fi
