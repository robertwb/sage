#!/usr/bin/env bash

if [ -z $SAGE_LOCAL ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# Let the user define the environment variable CFLAG64 to
# something if their C compiler needs a compiler flag other than
# -m64 to build 64-bit objects. This would be the case with IBM's
# compiler on AIX and HP's compiler on HP-UX. But -m64 works
# with both GCC and SunStudio.

if [ -z $CFLAG64 ] ; then
   CFLAG64=-m64
fi

# Create a 64-bit build if the environment variable SAGE64 is set to
# "yes".

if [ "x$SAGE64" = xyes ] ; then
   CFLAGS="$CFLAGS $CFLAG64"
   export CFLAGS
   LDFLAGS="$LDFLAGS $CFLAG64"
   export LDFLAGS
fi

cd src

echo ""
echo "GNU 'patch' will now be tested. Some of these tests will only"
echo "be performed if the GNU version of 'diff' is found - they will"
echo "be bypassed otherwise. Hence for the most extensive testing"
echo "the GNU version of 'diff' should be available."
echo ""

$MAKE check

if [ $? -ne 0 ]; then
    echo "Error found when testing GNU patch"
    exit 1
fi
