#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

cd src/

cp ../patches/main.c demosrc

CUR=`pwd`
cd unix

cp ../../patches/Make-arch .
cp ../../patches/Make-config .

finished()
{
   if [ $? -ne 0 ]; then
      echo "Error building Tachyon Ray Tracer"
      exit 1
   fi

   cd "$CUR"
   cp compile/*/tachyon "$SAGE_LOCAL/bin"
   exit 0
}

if [ $UNAME = "CYGWIN" ]; then
    $MAKE win32
    finished
fi

if [ $UNAME = "Darwin" ]; then
    #make macosx-thr
    # The threaded version of the 0.98 beta doesn't work on OS X.
    if [ "$SAGE64" = "yes" ]; then
        echo "Building 64 bit MacOSX"
        $MAKE macosx-64
    else
        $MAKE macosx
    fi
    finished
fi

if [ $UNAME = "FreeBSD" ]; then
    # Tachyon doesn't have a threaded option for FreeBSD (though it shouldn't
    # be too difficult to add).  There's no need for an explicit 64-bit
    # version since the only difference is a slight performance optimisation.
    $MAKE bsd
    finished
fi

if [ $UNAME = "Linux" ]; then
    case "`uname -m`" in
	i?86)
            $MAKE linux-thr;;
	ia64)
            $MAKE linux-ia64-thr;;
	amd64|x86_64)
            $MAKE linux-64-thr;;
	ppc)
            $MAKE linux-ppc;;
        armv7l)
            sed "s/-m32//g" ../../patches/Make-arch > Make-arch
            $MAKE linux-thr;;
	*) # e.g. ppc64
            echo "Sorry, your platform isn't supported by Tachyon and/or Sage. Exiting..."
            exit 1
    esac
    finished
fi

if [ $UNAME = "SunOS" ]; then
    if [ "x$SAGE64" = xyes ] ; then
       # There was nothing suitable for 64-bit mode with
       # gcc, so I made a new target. David Kirkby, May 2010.
       $MAKE solaris-pthreads-gcc-64-bit
    else
       $MAKE solaris-pthreads-gcc
    fi
    finished
fi

if [ "x$UNAME" = xAIX ]; then
    CFLAGS="$CFLAGS -g -O2"
    export CFLAGS
    $MAKE aix-generic-thr
    finished
fi

if [ "x$UNAME" = xHP-UX ]; then
    CFLAGS="$CFLAGS -g -O2"
    export CFLAGS
    $MAKE hpux-generic-thr
    finished
fi


echo "Tachyon build for $UNAME not implemented (for SAGE) - please complain on sage-devel."
exit 1
