#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

cd src/

CUR=`pwd`

cd unix

cp ../../patches/Make-arch .
cp ../../patches/Make-config .

finished()
{
   if [ $? -ne 0 ]; then
      echo "Error building Tachyon Ray Tracer"
      exit 1
   fi

   cd "$CUR"
   cp compile/*/tachyon "$SAGE_LOCAL/bin"
   exit 0
}

if [ $UNAME = "CYGWIN" ]; then
    make win32
    finished
fi

if [ $UNAME = "Darwin" ]; then
    #make macosx-thr
    # The threaded version of the 0.98 beta doesn't work on OS X.
    if [ "$SAGE64" = "yes" ]; then
        echo "Building 64 bit MaxOSX"
        make macosx-64
    else
        make macosx
    fi
    finished
fi

if [ $UNAME = "FreeBSD" ]; then
    # Tachyon doesn't have a threaded option for FreeBSD (though it shouldn't
    # be too difficult to add).  There's no need for an explicit 64-bit
    # version since the only difference is a slight performance optimisation.
    make bsd
    finished
fi

if [ $UNAME = "Linux" ]; then
    GCCVERSION=`gcc -dumpversion`
    case $GCCVERSION in
      4.2.4* | 4.3*)
        export GCCFIX="-fno-crossjumping -fno-reorder-blocks";;
      *);;
    esac
    make linux-thr
    if [ $? -ne 0 ]; then
        echo "Maybe your system is 64-bit; trying again."
        if [ `uname -m` = "ia64" ]; then
	  echo "ia64"
	  make linux-ia64-thr
        else
          echo "64-bit arch"
          make linux-64-thr
        fi
    fi
    finished
fi

if [ $UNAME = "SunOS" ]; then
    if [ "x$SAGE64" = xyes ] ; then
       # There was nothing suitable for 64-bit mode with
       # gcc, so I made a new target. David Kirkby, May 2010.
       make solaris-pthreads-gcc-64-bit
    else
       make solaris-pthreads-gcc
    fi
    finished
fi

echo "Tachyon build for $UNAME not implemented (for SAGE) - please complain on sage-devel"
exit 1
