#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

cp patches/lanczos.h  src/

cd src

if [ `uname -m` = "x86_64" ]; then
    # Note from David Kirkby. This seems a bit risky, as there
    # is no good reason to assume only Opteron systems give
    # x86_64 as the output of 'uname -m'
    cp makefile.opteron makefile
else
    if [ "x$SAGE64" = xyes ]; then
        # Despite being called makefile.osx64, this is a pretty generic
        # makefile, which should build 64-bit on many platforms, not just
        # OS X.
        echo "Building a 64-bit version of William Hart's Quadratic Sieve"
        cp makefile.osx64 makefile
    else
        cp makefile.sage makefile
    fi
fi

$MAKE

if [ $? -ne 0 ]; then
    echo "Error building William Hart's Quadratic Sieve"
    if [ `uname -m` = "x86_64" ]; then
       $CP makefile.sage makefile
       $MAKE
    else
       exit 1
    fi
fi

if [ $? -ne 0 ]; then
    echo "Error building William Hart's Quadratic Sieve"
    exit 1
fi

if [ ! -f QuadraticSieve ]; then
    echo "Error building William Hart's Quadratic Sieve -- no file QuadraticSieve was produced."
    exit 1
fi

$CP QuadraticSieve "$SAGE_LOCAL"/bin/

exit 0
