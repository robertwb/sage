#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# Let the environment variable CFLAG64 specify the compiler flag
# to build 64-bit code. It it is not set, set it to -m64
if [ -z $CFLAG64 ] ; then
   CFLAG64=-m64
fi

# If SAGE64 is "yes", build 64-bit.
if [ "x$SAGE64" = xyes ] ; then
   echo "Building Sympow 64-bit"
   CFLAGS="$CFLAGS $CFLAG64"
   LDFLAGS="$LDFLAGS $CFLAG64"
   export CFLAGS
   export LDFLAGS
fi

cp patches/Configure src/

cd src/

./Configure

if [ $? -ne 0 ]; then
   echo "Error configuring sympow"
   exit 1
fi

make

if [ $? -ne 0 ]; then
   echo "Error building sympow"
   echo "Trying again without possibility of using assembler"
   NO_ASSEMBLER="true"
   export NO_ASSEMBLER
   ./Configure
   make
fi

if [ $? -ne 0 ]; then
   echo "Error building sympow (even without assembler)"
   exit 1
fi

if [ ! -f sympow ]; then
   echo "sympow executable missing"
   exit 1
fi

TARGET="$SAGE_LOCAL/lib/sympow"

if [ -d "$TARGET" ]; then
    rm -rf "$TARGET"
fi
mkdir "$TARGET"

mv datafiles "$TARGET/"

if [ ! -d "$TARGET/datafiles" ]; then
   echo "Error installing sympow datafiles."
   exit 1
fi

cp sympow *.gp new_data "$TARGET/"

if [ ! -f "$TARGET/sympow" ]; then
   echo "sympow executable didn't copy correctly"
   exit 1
fi

SCRIPT="$SAGE_LOCAL/bin/sympow"

echo "#!/bin/sh" > $SCRIPT
echo "cd \$SAGE_LOCAL/lib/sympow" >> $SCRIPT
echo "./sympow \$*" >> $SCRIPT
chmod +x $SCRIPT

exit 0
