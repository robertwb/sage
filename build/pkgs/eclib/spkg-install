#!/bin/sh

CUR=`pwd`

echo "Deleting old versions of cremona libraries, which"
echo "would interfere with new builds."
cd "$SAGE_LOCAL"/lib/
rm libcurvesntl.* libg0nntl.* libjcntl.* librankntl.*

cd "$CUR"/src

NTL_PREFIX="$SAGE_LOCAL"
export NTL_PREFIX

PARI_PREFIX="$SAGE_LOCAL"
export PARI_PREFIX
if [ `uname` != "Darwin" ]; then
    PICFLAG=-fPIC
    export PICFLAG
fi

make

if [ $? -ne 0 ]; then
    echo "Error building cremona"
    exit 1
fi

if [ `uname` = "Darwin" ]; then
    make shared_dylib
else
    make shared_so
fi

if [ $? -ne 0 ]; then
    echo "Error building cremona shared libraries"
    exit 1
fi

if [ `uname` = "Darwin" ]; then
    cp lib/*.dylib "$SAGE_LOCAL"/lib/
else
    cp lib/*.so "$SAGE_LOCAL"/lib/
fi

INC_TARGET="$SAGE_LOCAL"/include/cremona
rm -rf "$INC_TARGET"
cp -r include "$INC_TARGET"

cp qrank/mwrank "$SAGE_LOCAL"/bin
cp qrank/tmrank "$SAGE_LOCAL"/bin
cp qrank/ratpoint "$SAGE_LOCAL"/bin
cp qcurves/findinf "$SAGE_LOCAL"/bin
cp qcurves/tate "$SAGE_LOCAL"/bin
cp qcurves/conductor "$SAGE_LOCAL"/bin
cp qcurves/torsion "$SAGE_LOCAL"/bin
cp qcurves/twist "$SAGE_LOCAL"/bin
cp qcurves/allisog "$SAGE_LOCAL"/bin
cp qcurves/indep "$SAGE_LOCAL"/bin
cp procs/tconic "$SAGE_LOCAL"/bin
