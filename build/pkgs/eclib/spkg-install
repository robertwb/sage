#!/bin/sh

CUR=`pwd`

echo "Deleting old versions of cremona libraries, which"
echo "would interfere with new builds."
cd "$SAGE_LOCAL"/lib/
rm libcurvesntl.* libg0nntl.* libjcntl.* librankntl.* libmwrank.*

cd "$CUR"/src

NTL_PREFIX="$SAGE_LOCAL"
export NTL_PREFIX

PARI_PREFIX="$SAGE_LOCAL"
export PARI_PREFIX
if [ `uname` != "Darwin" ]; then
    PICFLAG=-fPIC
    export PICFLAG
fi

make

if [ $? -ne 0 ]; then
    echo "Error building cremona"
    exit 1
fi

if [ `uname` = "Darwin" ]; then
    make dylib
else
    make so
fi

if [ $? -ne 0 ]; then
    echo "Error building cremona shared libraries"
    exit 1
fi

if [ `uname` = "Darwin" ]; then
    cp lib/*.dylib "$SAGE_LOCAL"/lib/
else
    cp lib/*.so "$SAGE_LOCAL"/lib/
fi

INC_TARGET="$SAGE_LOCAL"/include/cremona
rm -rf "$INC_TARGET"
cp -r include "$INC_TARGET"

#delete some leftovers from mwrank
rm -rf "$SAGE_LOCAL"/include/mwrank
rm -rf "$SAGE_LOCAL"/bin/tmwrank

# copy new binaries
cp qrank/mwrank "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/mwrank
cp qrank/ratpoint "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/ratpoint
cp qcurves/findinf "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/findinf
cp qcurves/tate "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/tate
cp qcurves/conductor "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/conductor
cp qcurves/torsion "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/torsion
cp qcurves/twist "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/twist
cp qcurves/allisog "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/allisog
cp qcurves/indep "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/indep
cp procs/tconic "$SAGE_LOCAL"/bin
strip "$SAGE_LOCAL"/bin/tconic
