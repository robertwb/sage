#!/bin/sh

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

echo "Deleting old libraries"
rm -f "$SAGE_LOCAL"/lib/libmpfr.*
echo "Deleting old headers"
rm -f "$SAGE_LOCAL"/include/*mpfr*

build()
{
    if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
         echo "64 bit MacIntel"
         CFLAGS="-O2 -g -m64 "; export CFLAGS
         CXXFLAGS="-O2 -g -m64 "; export CXXFLAGS
         CPPFLAGS="-O2 -g -m64 "; export CPPFLAGS
    fi

    EXTRA=""

    if [ ! -f "$SAGE_LOCAL/include/gmp.h" ]; then
         EXTRA="--disable-static --enable-shared"
    fi

    if [ $UNAME = "CYGWIN" ]; then
         EXTRA="--disable-static --enable-shared"
    fi

    ./configure --prefix=$SAGE_LOCAL --with-gmp=$SAGE_LOCAL \
                 CFLAGS="$CFLAGS $SHAREDFLAGS -O2" CXX="$CXX" \
                 CXXFLAGS="$CXXFLAGS $SHAREDFLAGS" LDFLAGS="$LDFLAGS" \
                 GMP_PREFIX="$SAGE_LOCAL" $EXTRA

    echo "Building MPFR"
    $MAKE

    echo "Installing MPFR"
    MAKE=make; export MAKE
    $MAKE install
}

cd src

build

if [ $? -eq 0 -a -f $SAGE_LOCAL/include/mpfr.h ];  then
    exit 0
else
    echo "An error occured while building mpfr."
    exit 1
fi

#uncomment the line below to avoid running the test suite.
#this should be done in all final releases
#exit 0
cd ..; ./spkg-check
