#!/usr/bin/env bash

CUR=`pwd`

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# numpy's distutils is buggy and runs a conftest without
# taking CFLAGS into account. With 64 bit OSX this results
# in *boom*
if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
   echo "64 bit MacIntel: copying fake gcc"
   rm $SAGE_LOCAL/bin/gcc
   cp gcc_fake $SAGE_LOCAL/bin/gcc
   chmod 755 $SAGE_LOCAL/bin/gcc
fi

if [ $UNAME = "CYGWIN" ]; then
    echo "CYGWIN: Patching src/numpy/linalg/setup.py"
    cp patches/cygwin-lapack_lite-setup.py src/numpy/linalg/setup.py
fi


cd src

echo "[DEFAULT]" > site.cfg
echo "library_dirs = $SAGE_LOCAL/lib" >> site.cfg
echo "include_dirs = $SAGE_LOCAL/include" >> site.cfg
echo "" >> site.cfg


if [ `uname` = "Darwin" ]; then
    unset ATLAS
    unset BLAS
    unset LAPACK
fi

################################################

cp ../patches/gnu.py numpy/distutils/fcompiler/gnu.py
cp ../patches/__init__.py  numpy/distutils/fcompiler/__init__.py

rm -rf "$SAGE_LOCAL"/lib/python/site-packages/numpy

# Program around a bug in SciPY's distutils.
unset CFLAGS

python setup.py install

if [ $? -ne 0 ]; then
    echo "Error building numpy."
    exit 1
fi

if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
   echo "64 bit MacIntel: deleting fake gcc"
   rm $SAGE_LOCAL/bin/gcc
fi


$CUR/bin/update-pxi.py $CUR/src/numpy/doc/cython/numpy.pxi $SAGE_ROOT/devel/sage/sage/ext/numpy.pxi

if [$? -ne 0]; then
    exit 1
fi
