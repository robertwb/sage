#!/usr/bin/env bash

########################################################
# Build Sage source distribution
# This script should be called by the sage-sage script
########################################################

PKGDIR=spkg

if [ $# -ne 2 ]; then
   echo "Usage: $0 <SAGE_VERSION> <SAGE_ROOT>"
   exit 1
fi

SAGE_VERSION=$1
SAGE_ROOT=$2

# are we trying to sdist a bdist copy? If so, tell the user about it and
# fail.
if [ -f $SAGE_ROOT/spkg/standard/.from_bdist ]
then
  cat <<EOF
You are running 'sage -sdist' on a copy of Sage that was created with
'sage -bdist'; this copy includes placeholders for the spkg files and
does not have the SAGE_ROOT/spkg/base directory, so a source
distribution cannot be made from this copy of Sage.

You can fix this by:

  * putting the "real" spkg files into spkg/standard; get a source
    tarball for this version of Sage and copy the directory.
  * copying the spkg/base directory from the source tarball into this
    copy of Sage.
  * removing the file spkg/standard/.from_bdist.

Cannot create source distribution. Exiting.
EOF
  exit 1
fi

LD_LIBRARY_PATH="$SAGE_ROOT/local/lib:$LD_LIBRARY_PATH" && export LD_LIBRARY_PATH
export SAGE_ROOT SAGE_VERSION
TARGET="sage-$1"

CUR=`pwd`

SAGE_RELEASE_DATE=`date -u +'%Y-%m-%d'`

# Update Sage version file in SAGE_ROOT.
echo "Sage version $SAGE_VERSION, released $SAGE_RELEASE_DATE" > "$SAGE_ROOT"/VERSION.txt

# Update Sage version file in devel/sage/sage: this is done here so
# the banner produced below this if block is correct.
if [ -d "$SAGE_ROOT"/devel/sage/sage ]; then
   cd "$SAGE_ROOT"/devel/sage/sage
   echo '"""nodoctests"""' > version.py
   echo "version='"$SAGE_VERSION"'; date='"$SAGE_RELEASE_DATE"'" >> version.py
   cd "$SAGE_ROOT"/devel/sage
   python setup.py install
fi

cd "$SAGE_ROOT"/local/bin/
echo "import sage.misc.banner; sage.misc.banner.banner()" | ./python > sage-banner

cd "$CUR"

cp "$SAGE_ROOT"/local/bin/sage-spkg "$PKGDIR"/base/
cp "$SAGE_ROOT"/local/bin/sage-env "$PKGDIR"/base/
cp "$SAGE_ROOT"/local/bin/sage-make_relative "$PKGDIR"/base/

TMP="/tmp/$TARGET"

rm -rf "$TMP"
mkdir "$TMP"

# copy sage root repo over.  Cloning needs to be done in an empty
# directory, so we do this now.  The other sage repositories are dealt
# with later.
cd "$SAGE_ROOT"

hg diff
hg status
hg tag "$SAGE_VERSION"
hg commit -m "$SAGE_VERSION"

echo "Copying root repository..."
hg clone --pull . "$TMP"

if [ $? -ne 0 ]; then
    echo "Error copying Sage root repository."
    exit 1
fi

rm "$TMP"/.hg/hgrc
echo "Done copying root repository."

STD=standard
# Put VERSION.txt in a directory available for download during the
# update process.  (See sage-update.)
cp -p VERSION.txt $TMP/$PKGDIR/$STD/
cp -pr "$PKGDIR"/base "$TMP/$PKGDIR/"

"$SAGE_ROOT"/local/bin/sage-make_devel_packages "$SAGE_VERSION" "$SAGE_ROOT" "$TMP"/devel

if [ $? -ne 0 ]; then
    echo "Error building the Sage packages."
    exit 1
fi

cp "$TMP"/devel/*.spkg "$SAGE_ROOT/$PKGDIR/$STD/"

cp -p "$PKGDIR/$STD"/*.spkg "$TMP/$PKGDIR/$STD/"

cd "$TMP/$PKGDIR/$STD"
rm -rf doc-* sage-* extcode-* sage_scripts-* examples-*
mv "$TMP"/devel/*.spkg .
rmdir "$TMP"/devel

cd /tmp
tar cf "$TARGET".tar "$TARGET"

mkdir -p "$SAGE_ROOT"/dist

rm -rf "$SAGE_ROOT/dist/$TARGET"

mv "$TARGET" "$SAGE_ROOT"/dist/
mv "$TARGET".tar "$SAGE_ROOT"/dist/
