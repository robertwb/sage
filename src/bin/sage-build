#!/bin/sh

build() {
   if [ -d $SAGE_ROOT/devel/$1/ ]; then
      cd $SAGE_ROOT/devel/$1/
      chmod +x ./install
      echo ""
      echo "----------------------------------------------------------"
      echo "sage: Building and installing modified SAGE library files."
      echo ""
      ./install $SAGE_ROOT
      if [ $? -ne 0 ]; then
         echo "sage: There was an error installing modified $1 library code."
         echo ""
         exit 1
      fi
   #else
      #echo "The directory $SAGE_ROOT/devel/$1/ does not exist."
   fi
}

$SAGE_ROOT/local/bin/sage-env 1>/dev/null

if [ "$1" = "-b" ]; then
    DO_TOUCH=1
    shift
else
    DO_TOUCH=0
fi

if [ "$1" != "" ]; then
    # make devel/sage point to devel/$1
    cd "$SAGE_ROOT/devel/"
    if [ ! -d "sage-$1" ]; then
        # this will happen a lot because of people (=me) making typos.
        echo "No such branch '$SAGE_ROOT/devel/sage-$1'"
	echo "Use 'sage -clone' to create a new branch."
        exit 1
    fi
    ln -snf "sage-$1" sage
fi

if [ ! -d "$SAGE_ROOT/devel/sage" ]; then
    echo "There is no directory '$SAGE_ROOT/devel/sage'"
    exit 1
fi

if [ DO_TOUCH = 1 ]; then
   CUR=`pwd`
   cd "$SAGE_ROOT/devel/sage/sage"
   touch */*.pyx */*/*.pyx */*/*/*.pyx */*/*/*/*.pyx */*/*/*/*/*.pyx */*/*/*/*/*.pyx  */*/*/*/*/*/*.pyx 2> /dev/null
   cd "$CUR"
fi

build "sage"
