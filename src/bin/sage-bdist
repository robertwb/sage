#!/usr/bin/env bash

########################################################
# Build Sage *binary* distribution
# This script should be called by the spkg/bin/sage script
#
# Released under the GNU GPL-v2+ -- (c) William Stein
########################################################

sage -c "print 'Sage works!'"
if [ $? -ne 0 ]; then
    echo "Sage doesn't even start.  Refusing to make a binary."
    exit 1
fi

PKGDIR=spkg

CUR=`pwd`

CP_OPT="-pPR"

if [ $# -ne 2 ]; then
   echo "Usage: $0 <SAGE_VERSION> <SAGE_ROOT>"
   exit 1
fi

# If $1 starts with "sage-", remove this prefix
export SAGE_VERSION=`echo "$1" | sed 's/^sage-//'`
export SAGE_ROOT=$2

TARGET=sage-"$SAGE_VERSION"-`uname -m`-`uname`
TARGET=`echo $TARGET | sed -e 's/ //'`     #no blank spaces
TMP="$CUR/tmp/$TARGET"

mkdir -p "$CUR/tmp"

rm -rf "$TMP"
mkdir "$TMP"

# copy sage root repo over:
cd "$SAGE_ROOT"

echo "Copying root repository..."
hg clone --pull . "$TMP"

if [ $? -ne 0 ]; then
    echo "Error copying Sage root repository."
    exit 1
fi

rm "$TMP"/.hg/hgrc
echo "Done copying root repository."

cd "$SAGE_ROOT"

echo "Copying files over to tmp directory"
cp $CP_OPT local data "$TMP"/

if [ -d devel/sage-main ]; then
   echo "Copying Sage library over"
   mkdir "$TMP"/devel/
   # The currently active branch will become the default branch in
   # the bdisted tarball.  We need the -L option, otherwise "cp" would
   # simply copy the symbolic link.
   cp $CP_OPT -L devel/sagenb "$TMP"/devel/sagenb-main
   cp $CP_OPT -L devel/sage "$TMP"/devel/sage-main
   cd "$TMP"/devel
   ln -s sage-main sage
   ln -s sagenb-main sagenb
   cd sage
   # Delete cython hash, so that "sage -br" works the first time.
   rm -f .cython_hash
   cd "$TMP"/local/lib/python/site-packages && \
   rm -rf sage
   ln -sf ../../../../devel/sage/build/sage .
fi

cd "$SAGE_ROOT"

if [ -d "$PKGDIR" ]; then
   echo "Making empty spkg's"
   cd "$PKGDIR"
   mkdir "$TMP/$PKGDIR"/build
   mkdir "$TMP/$PKGDIR"/optional
   cp $CP_OPT installed "$TMP/$PKGDIR/"
   cp $CP_OPT standard "$TMP/$PKGDIR/"
   cd "$TMP/$PKGDIR"/standard/
   for spkg in *.spkg; do
       echo "Placeholder spkg file so this binary version of Sage knows this package version used when installing Sage." >"$spkg"
   done
   # sage -sdist uses the following file to detect if it's working with
   # a "bdisted" copy
   touch $TMP/$PKGDIR/standard/.from_bdist
fi

cd "$CUR"/tmp/
if [ "$UNAME" = "Darwin" ]; then
    cd "$TARGET"
    mkdir x
    echo "There will be an error about x below that you can safely ignore."
    mv * .hg* x
    mv x sage
    cp sage/local/bin/sage-README-osx.txt README.txt

    if [ "$SAGE_APP_BUNDLE" = "yes" ]; then

        echo 'Building the Mac Application'

        # Some people don't have the 10.4 sdk installed, but using the default on 10.4 causes problems
        if [ "$MACOSX_DEPLOYMENT_TARGET" = "10.4" -a -e '/Developer/SDKs/MacOSX10.4u.sdk' ]; then
            SET_SDKROOT='SDKROOT=/Developer/SDKs/MacOSX10.4u.sdk'
        else
            SET_SDKROOT=''
        fi

        CONFIGURATION='Debug'
        # Note that we don't have to build this part with the same
        # compiler as everything else, and in fact it causes problems
        # to do so.
        (cd "$SAGE_ROOT/data/extcode/sage/ext/mac-app/" && \
            unset CC LD && \
            xcodebuild -target 'Sage' -configuration "$CONFIGURATION" \
            ARCHES="$(uname -m)" \
            $SET_SDKROOT)

        if [ $? -ne 0 ]; then
            echo "Failed to build Sage.app."
            echo "If you don't wish to build Sage.app set SAGE_APP_BUNDLE=no"
            exit 1
        fi

        echo 'Copying Sage.app'
        cp $CP_OPT -L "$SAGE_ROOT/data/extcode/sage/ext/mac-app/build/$CONFIGURATION/Sage.app" ./Sage.app
        # Info.plist is a binary plist, so convert it for processing with sed.
        # I would just change it to be an xml plist, but xcode changes it back.
        plutil -convert xml1 ./Sage.app/Contents/Info.plist
        sed -i '' "s/SAGE_VERSION/$SAGE_VERSION/" \
            ./Sage.app/Contents/Info.plist \
            ./Sage.app/Contents/Resources/English.lproj/InfoPlist.strings

        mv sage ./Sage.app/Contents/Resources/

        # Rename it with the version number
        mv Sage.app "Sage-$SAGE_VERSION.app"
    else
        echo 'If you wish to create a Mac Application please set'
        echo 'SAGE_APP_BUNDLE=yes'
    fi

    # Go back to the right directory for later copying
    cd "$CUR"/tmp/
    if [ "$SAGE_APP_DMG" != "no" ]; then
        echo "Creating dmg"
        echo "(If you don't wish to create a disk image please set SAGE_APP_DMG=no)"
        DYLD_LIBRARY_PATH="$SAGE_ORIG_DYLD_LIBRARY_PATH"; export DYLD_LIBRARY_PATH
        hdiutil create -srcfolder "$TARGET" -format UDBZ "$TARGET".dmg
    else
        echo 'If you wish to create a disk image please set'
        echo 'SAGE_APP_DMG=yes'
        echo '(or to anything else but the current SAGE_APP_DMG=no,'
        echo ' or completely unset SAGE_APP_DMG)'
        echo "Creating tar.gz"
        tar zcvf "$TARGET".tar.gz "$TARGET"
    fi
else
    echo "Creating tar.gz"
    tar zcvf "$TARGET".tar.gz "$TARGET"
fi

mkdir -p "$SAGE_ROOT"/dist

rm -rf "$SAGE_ROOT/dist/$TARGET"

echo "Moving final distribution file to $SAGE_ROOT/dist"

mv "$TARGET" "$SAGE_ROOT"/dist/
mv "$TARGET".* "$SAGE_ROOT"/dist/
